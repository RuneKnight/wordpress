<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²Œì„ ëª¨ë“œ íƒ€ì´ë¨¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
        #timer-display {
            /* í°íŠ¸ í¬ê¸°ë¥¼ í™”ë©´ ë„ˆë¹„ì— ë”°ë¼ ìœ ë™ì ìœ¼ë¡œ ì¡°ì ˆ (ìµœì†Œ 3rem, ê¸°ë³¸ 18vw, ìµœëŒ€ 5.5rem) */
            font-size: clamp(3rem, 18vw, 5.5rem);
            line-height: 1;
        }
        .timer-ring-container {
            transition: transform 0.5s ease;
        }
        .time-warning .timer-ring-container { animation: pulse 1s infinite; }
        .time-critical .timer-ring-container { animation: shake 0.5s infinite; }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.03); }
        }
        @keyframes shake {
            0%, 100% { transform: translate(0, 0) rotate(0); }
            25% { transform: translate(2px, -2px) rotate(1deg); }
            50% { transform: translate(-2px, 2px) rotate(-1deg); }
            75% { transform: translate(2px, 2px) rotate(1deg); }
        }
        .leaderboard-item { transition: all 0.3s ease; }
        .leaderboard-item-clickable { cursor: pointer; }
        .current-leader {
             transform: scale(1.05);
        }
        .selected-leaderboard-item {
            background-color: #eef2ff; /* indigo-100 */
            border-color: #818cf8 !important; /* indigo-400 */
            transform: scale(1.05);
        }
        .eliminated {
            opacity: 0.5;
            text-decoration: line-through;
            background-color: #e2e8f0; /* slate-200 */
        }
        #notification {
            transition: opacity 0.5s, transform 0.5s;
        }
        /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        input[type="color"] {
        	-webkit-appearance: none;
        	border: none;
        	width: 32px;
        	height: 32px;
            cursor: pointer;
            border-radius: 50%;
            overflow: hidden;
        }
        input[type="color"]::-webkit-color-swatch-wrapper {
        	padding: 0;
        }
        input[type="color"]::-webkit-color-swatch {
        	border: none;
            border-radius: 50%;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 flex flex-col items-center min-h-screen p-4">

    <div id="app-container" class="w-full max-w-4xl mx-auto">
        
        <!-- ì„¤ì • ì„¹ì…˜ -->
        <div id="settings-view" class="bg-white p-6 rounded-2xl shadow-lg mb-6">
            <h1 class="text-3xl font-bold text-center text-blue-600 mb-6">ê²Œì„ íƒ€ì´ë¨¸ ì„¤ì •</h1>
            
            <div class="mb-6">
                <label for="game-name-input" class="text-xl font-semibold mb-3 text-slate-700 block">ê²Œì„ ì´ë¦„</label>
                <input type="text" id="game-name-input" placeholder="ì˜¤ëŠ˜ì˜ ê²Œì„ ì´ë¦„ì€?" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
            </div>

            <div class="grid md:grid-cols-2 gap-x-8 gap-y-6 border-t pt-6">
                <!-- í”Œë ˆì´ì–´ ì¶”ê°€ -->
                <div>
                    <h2 class="text-xl font-semibold mb-3 text-slate-700">1. í”Œë ˆì´ì–´ ì¶”ê°€</h2>
                    <div class="flex items-center gap-2">
                        <input type="color" id="new-user-color" value="#3b82f6" title="ìƒ‰ìƒ ì„ íƒ">
                        <input type="text" id="new-user-name" placeholder="í”Œë ˆì´ì–´ ì´ë¦„ (1-100ëª…)" class="flex-grow w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        <button id="add-user-btn" class="bg-blue-500 text-white px-6 py-2 rounded-lg font-semibold hover:bg-blue-600 shadow">ì¶”ê°€</button>
                    </div>
                    <div id="user-list" class="mt-4 space-y-2 max-h-40 overflow-y-auto pr-2"></div>
                </div>

                <!-- ì‹œê°„ ì„¤ì • -->
                <div>
                    <h2 class="text-xl font-semibold mb-3 text-slate-700">2. ì‹œê°„ ì„¤ì •</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="turn-time" class="block text-sm font-medium text-slate-600">ê¸°ë³¸ ì‹œê°„ (ì´ˆ)</label>
                            <input type="number" id="turn-time" value="30" min="1" class="w-full mt-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="extra-time" class="block text-sm font-medium text-slate-600">ì¶”ê°€ ì‹œê°„ (ì´ˆ)</label>
                            <input type="number" id="extra-time" value="60" min="0" class="w-full mt-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                </div>

                <!-- ê²Œì„ ëª¨ë“œ ì„¤ì • -->
                <div class="md:col-span-2 border-t pt-6">
                    <h2 class="text-xl font-semibold mb-4 text-slate-700">3. ê²Œì„ ëª¨ë“œ ì„¤ì •</h2>
                    <div class="space-y-4">
                        <label class="flex items-center gap-3 p-3 bg-slate-50 rounded-lg">
                            <input type="checkbox" id="sudden-death-mode" class="h-5 w-5 rounded text-blue-600 focus:ring-blue-500">
                            <span class="font-medium">ì„œë“ ë°ìŠ¤ ëª¨ë“œ í™œì„±í™”</span>
                        </label>
                        <div class="p-3 bg-slate-50 rounded-lg">
                            <label class="flex items-center gap-3">
                                <input type="checkbox" id="quick-turn-bonus-mode" checked class="h-5 w-5 rounded text-blue-600 focus:ring-blue-500">
                                <span class="font-medium">í€µ í„´ ë³´ë„ˆìŠ¤</span>
                            </label>
                            <div class="text-sm text-slate-500 mt-2 pl-8">
                                í„´ ì‹œì‘ í›„ <input type="number" id="bonus-condition-time" value="5" class="w-16 text-center mx-1 border-b">ì´ˆ ì•ˆì— ë„˜ê¸°ë©´ ì¶”ê°€ ì‹œê°„ <input type="number" id="bonus-reward-time" value="3" class="w-16 text-center mx-1 border-b">ì´ˆ íšë“!
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-8 text-center">
                <button id="start-timer-btn" class="bg-green-500 text-white px-10 py-3 rounded-lg font-bold text-lg hover:bg-green-600 shadow-lg disabled:bg-slate-400 disabled:cursor-not-allowed">ê²Œì„ ì‹œì‘</button>
            </div>
        </div>

        <!-- íƒ€ì´ë¨¸ ë·° -->
        <div id="timer-view" class="hidden relative">
            <!-- ìŒì†Œê±° ë²„íŠ¼ -->
            <button id="mute-btn" class="absolute top-4 right-4 z-10 p-2 bg-white rounded-full shadow-md">
                <svg id="volume-icon" class="w-6 h-6 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path></svg>
                <svg id="mute-icon" class="w-6 h-6 text-slate-600 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15zM17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2"></path></svg>
            </button>
            <!-- ë³´ë„ˆìŠ¤ ì•Œë¦¼ -->
            <div id="notification" class="absolute top-1/3 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-yellow-300 text-yellow-800 font-bold px-6 py-3 rounded-full shadow-lg opacity-0 transform scale-50 z-20"></div>

            <div class="grid lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-lg flex flex-col items-center justify-center text-center">
                    <h2 id="current-user-name" class="text-4xl font-bold mb-2">í”Œë ˆì´ì–´ ì´ë¦„</h2>
                    <p class="text-slate-500 mb-6">ë‹˜ì˜ ì°¨ë¡€ì…ë‹ˆë‹¤</p>
                    
                    <div class="relative w-64 h-64 sm:w-80 sm:h-80 mb-6 timer-ring-container">
                        <svg class="w-full h-full" viewBox="0 0 100 100">
                            <circle class="text-slate-200" stroke-width="8" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" />
                            <circle id="timer-progress-ring" stroke-width="8" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" stroke-linecap="round" transform="rotate(-90 50 50)" style="stroke-dasharray: 282.7; stroke-dashoffset: 282.7;" />
                        </svg>
                        <div id="timer-display-container" class="absolute inset-0 flex flex-col items-center justify-center">
                            <span id="timer-display" class="font-bold">00:00</span>
                            <span id="extra-time-indicator" class="text-amber-500 font-bold text-lg hidden">ì¶”ê°€ ì‹œê°„ ì‚¬ìš© ì¤‘</span>
                        </div>
                    </div>
                    
                    <div id="user-extra-time-display" class="mb-6 text-lg">ë‚¨ì€ ì¶”ê°€ ì‹œê°„: <span id="current-user-extra-time" class="font-bold">0</span>ì´ˆ</div>

                    <div class="w-full px-4 sm:px-0 sm:max-w-xs sm:mx-auto">
                        <button id="next-turn-btn" class="w-full bg-amber-500 text-white px-6 py-4 rounded-lg font-bold text-lg hover:bg-amber-600 shadow-md">ì°¨ë¡€ ë„˜ê¸°ê¸°</button>
                        <button id="start-turn-btn" class="w-full bg-blue-500 text-white px-6 py-4 rounded-lg font-bold text-lg hover:bg-blue-600 shadow-md hidden">ì‹œì‘</button>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h3 class="text-2xl font-bold mb-2 text-center">ë¦¬ë”ë³´ë“œ</h3>
                        <p class="text-center text-sm text-slate-500 mb-4">ìˆœì„œ ë³€ê²½(â–²/â–¼) / ê¸°ë¡ ë³´ê¸°(í´ë¦­)</p>
                        <div id="leaderboard" class="space-y-3 max-h-80 overflow-y-auto pr-2"></div>
                    </div>

                    <!-- ìƒì„¸ ë©íƒ€ì„ ë·° -->
                    <div id="lap-details-view" class="hidden bg-white p-6 rounded-2xl shadow-lg">
                        <h3 id="lap-details-title" class="text-xl font-bold mb-4 text-center"></h3>
                        <div id="lap-details-list" class="space-y-2 max-h-48 overflow-y-auto pr-2 text-center"></div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-lg text-center">
                        <h3 class="text-2xl font-bold mb-4 text-center">ì œì–´íŒ</h3>
                        <button id="end-game-btn" class="w-full bg-red-500 text-white px-6 py-3 rounded-lg font-bold hover:bg-red-600 shadow">ê²Œì„ ì¢…ë£Œ</button>
                    </div>
                </div>
            </div>
             <div id="total-time-container" class="mt-6 text-center text-xl font-semibold text-slate-600">
                ì´ ì§„í–‰ ì‹œê°„: <span id="total-game-time">00:00</span>
            </div>
        </div>
        
        <!-- ê²Œì„ ì¢…ë£Œ ëª¨ë‹¬ -->
        <div id="game-over-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
            <div class="bg-white text-center p-10 rounded-2xl shadow-2xl transform transition-all scale-95">
                <h2 class="text-5xl font-bold text-yellow-500 mb-4">ğŸ† ìŠ¹ë¦¬ ğŸ†</h2>
                <p id="winner-name" class="text-3xl font-semibold text-slate-800 mb-8"></p>
                <button id="view-summary-btn" class="bg-blue-500 text-white px-8 py-3 rounded-lg font-bold text-lg hover:bg-blue-600">ê²°ê³¼ ë³´ê¸°</button>
            </div>
        </div>

        <!-- ë‹‰ë„¤ì„ ì¶”ì²œ ëª¨ë‹¬ -->
        <div id="nickname-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
            <div class="bg-white w-full max-w-md p-6 rounded-2xl shadow-xl">
                <h2 class="text-2xl font-bold text-center mb-4">í”Œë ˆì´ì–´ ì„¤ì •</h2>
                <p class="text-center text-slate-500 mb-6">ë‹‰ë„¤ì„ê³¼ ìƒ‰ìƒì„ ì„¤ì •í•´ì£¼ì„¸ìš”.</p>
                
                <div class="flex items-center justify-center gap-4 mb-6">
                    <label for="modal-user-color" class="font-medium text-slate-600">ìƒ‰ìƒ:</label>
                    <input type="color" id="modal-user-color" value="#3b82f6" title="ìƒ‰ìƒ ì„ íƒ">
                </div>

                <div class="flex items-center gap-2 mb-4">
                    <input type="text" id="modal-nickname-input" placeholder="ì›í•˜ëŠ” ë‹‰ë„¤ì„ ì…ë ¥" class="flex-grow w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div id="nickname-suggestions" class="grid grid-cols-3 gap-2 mb-6">
                </div>
                 <p id="modal-error-msg" class="text-red-500 text-center text-sm mb-4 h-5"></p>
                <div class="flex gap-4">
                    <button id="modal-cancel-btn" class="w-full bg-slate-200 text-slate-700 px-6 py-2 rounded-lg font-semibold hover:bg-slate-300">ì·¨ì†Œ</button>
                    <button id="modal-confirm-btn" class="w-full bg-blue-500 text-white px-6 py-2 rounded-lg font-semibold hover:bg-blue-600">í™•ì¸</button>
                </div>
            </div>
        </div>
        
        <!-- ì ìˆ˜ ì…ë ¥ ëª¨ë‹¬ -->
        <div id="score-input-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
            <div class="bg-white w-full max-w-md p-6 rounded-2xl shadow-xl">
                <h2 class="text-2xl font-bold text-center mb-4">ì ìˆ˜ ì…ë ¥</h2>
                <p class="text-center text-slate-500 mb-6">ê° í”Œë ˆì´ì–´ì˜ ìµœì¢… ì ìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
                <div id="score-input-list" class="space-y-4 max-h-80 overflow-y-auto pr-2 mb-6">
                    <!-- ì ìˆ˜ ì…ë ¥ í•„ë“œê°€ ì—¬ê¸°ì— ì‚½ì…ë©ë‹ˆë‹¤ -->
                </div>
                <button id="show-summary-from-scores-btn" class="w-full bg-blue-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-600">ê²°ê³¼ ë³´ê¸°</button>
            </div>
        </div>

        <!-- ìµœì¢… ê²°ê³¼ ëª¨ë‹¬ -->
        <div id="summary-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
            <div class="w-full max-w-lg">
                <div id="summary-content" class="bg-white p-8 rounded-2xl shadow-2xl">
                    <h2 id="summary-game-name" class="text-4xl font-bold text-center mb-2">ê²Œì„ ê²°ê³¼</h2>
                    <p class="text-center text-slate-500 mb-6">ì´ ì§„í–‰ ì‹œê°„: <span id="summary-total-time" class="font-semibold"></span></p>
                    <div id="summary-player-list" class="space-y-3 max-h-80 overflow-y-auto pr-2 border-t pt-4">
                        <!-- í”Œë ˆì´ì–´ ê²°ê³¼ ëª©ë¡ -->
                    </div>
                </div>
                <div class="mt-6 flex gap-4">
                    <button id="reset-game-btn" class="w-full bg-blue-500 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-600">ìƒˆ ê²Œì„ ì‹œì‘</button>
                    <button id="save-image-btn" class="w-full bg-green-500 text-white px-6 py-3 rounded-lg font-bold hover:bg-green-600">ì´ë¯¸ì§€ë¡œ ì €ì¥</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- UI ìš”ì†Œ ---
            const settingsView = document.getElementById('settings-view');
            const timerView = document.getElementById('timer-view');
            const gameNameInput = document.getElementById('game-name-input');
            const newUserInput = document.getElementById('new-user-name');
            const newUserColorInput = document.getElementById('new-user-color');
            const addUserBtn = document.getElementById('add-user-btn');
            const userListDiv = document.getElementById('user-list');
            const turnTimeInput = document.getElementById('turn-time');
            const extraTimeInput = document.getElementById('extra-time');
            const startTimerBtn = document.getElementById('start-timer-btn');
            const currentUserNameEl = document.getElementById('current-user-name');
            const timerDisplayEl = document.getElementById('timer-display');
            const extraTimeIndicator = document.getElementById('extra-time-indicator');
            const currentUserExtraTimeEl = document.getElementById('current-user-extra-time');
            const timerProgressRing = document.getElementById('timer-progress-ring');
            const nextTurnBtn = document.getElementById('next-turn-btn');
            const startTurnBtn = document.getElementById('start-turn-btn');
            const endGameBtn = document.getElementById('end-game-btn');
            const leaderboardDiv = document.getElementById('leaderboard');
            const timerRingContainer = document.querySelector('.timer-ring-container');
            const totalGameTimeEl = document.getElementById('total-game-time');
            const muteBtn = document.getElementById('mute-btn');
            const volumeIcon = document.getElementById('volume-icon');
            const muteIcon = document.getElementById('mute-icon');
            const notificationEl = document.getElementById('notification');
            const gameOverModal = document.getElementById('game-over-modal');
            const winnerNameEl = document.getElementById('winner-name');
            const viewSummaryBtn = document.getElementById('view-summary-btn');
            const lapDetailsView = document.getElementById('lap-details-view');
            const lapDetailsTitle = document.getElementById('lap-details-title');
            const lapDetailsList = document.getElementById('lap-details-list');
            const nicknameModal = document.getElementById('nickname-modal');
            const modalNicknameInput = document.getElementById('modal-nickname-input');
            const modalUserColorInput = document.getElementById('modal-user-color');
            const nicknameSuggestions = document.getElementById('nickname-suggestions');
            const modalConfirmBtn = document.getElementById('modal-confirm-btn');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');
            const modalErrorMsg = document.getElementById('modal-error-msg');
            const scoreInputModal = document.getElementById('score-input-modal');
            const scoreInputList = document.getElementById('score-input-list');
            const showSummaryFromScoresBtn = document.getElementById('show-summary-from-scores-btn');
            const summaryModal = document.getElementById('summary-modal');
            const summaryContent = document.getElementById('summary-content');
            const summaryGameName = document.getElementById('summary-game-name');
            const summaryTotalTime = document.getElementById('summary-total-time');
            const summaryPlayerList = document.getElementById('summary-player-list');
            const resetGameBtn = document.getElementById('reset-game-btn');
            const saveImageBtn = document.getElementById('save-image-btn');

            // --- ê²Œì„ ì„¤ì • UI ---
            const suddenDeathModeCheckbox = document.getElementById('sudden-death-mode');
            const quickTurnBonusCheckbox = document.getElementById('quick-turn-bonus-mode');
            const bonusConditionTimeInput = document.getElementById('bonus-condition-time');
            const bonusRewardTimeInput = document.getElementById('bonus-reward-time');

            // --- ìƒíƒœ ë³€ìˆ˜ ---
            let users = [];
            let gameName = "ê²Œì„";
            let currentUserIndex = 0;
            let timerInterval, totalGameTimeInterval;
            let timeLeft, totalSecondsElapsed;
            let turnStartTime;
            let turnTime;
            let isTimerRunning = false;
            let isExtraTimeActive = false;
            let isSuddenDeathActive = false;
            let isMuted = false;
            const ringCircumference = 2 * Math.PI * 45;
            const COLORS = { WARNING: '#f87171', EXTRA: '#fbbf24' };
            const COLOR_PALETTE = ['#3b82f6', '#ef4444', '#22c55e', '#eab308', '#8b5cf6', '#ec4899', '#14b8a6', '#f97316', '#6366f1', '#d946ef', '#0ea5e9', '#84cc16'];
            const NICKNAMES = ['ì „ì„¤ì˜íŠ¸ë¡¤', 'ë§Œë ™ì£¼ìˆ ì‚¬', 'ìª¼ë ™ì „ì‚¬', 'íì€ì…€í”„', 'ë¬¼ì•½ìƒì¸', 'ë“œë˜ê³¤ìŠ¬ë ˆì´ì–´', 'ì—˜í”„ê¶ìˆ˜', 'ì˜¤í¬ì˜ë¶„ë…¸', 'ê·¸ë¦¼ìì•”ì‚´ì', 'ë§ˆë²•ì‚¬ì˜ì œì', 'í—¤ë“œìƒ·ì¥ì¸', 'ëŒê²©ëŒ€ì¥', 'ì €ê²©ì˜ì‹ ', 'ìˆ˜ë¥˜íƒ„íˆ¬ì²™ê¸°', 'ë°±ì—…ì€ì—†ë‹¤', 'ë¬´ë¹™ì˜ë‹¬ì¸', 'ìƒ·ê±´ë§¤ë‹ˆì•„', 'ì—ì„ì˜ì‹ ', 'í•‘ê³„ëŠ”ì¥ë¹„íƒ“', 'ìµœí›„ì˜ìƒì¡´ì', 'ì˜¤ë”ëŠ”ë‚´ê°€ì§€íœ˜í•œë‹¤', 'ë¯¸ë“œì˜¤í”ˆ', 'ì •ê¸€ì˜ì§€ë°°ì', 'íƒ‘ì‹ ë³‘ì', 'ë°”í…€ë“€ì˜¤', 'í•œíƒ€ì˜ê·€ì¬', 'ìš´ì˜ì˜ë§ˆìˆ ì‚¬', 'ë§µí•µì˜ì‹¬ìœ ì €', 'ìºë¦¬ë¨¸ì‹ ', 'ì„±ì¥ì˜ëŒ€ê°€', 'ê²Œì„ì€ì¥ë¹„ë¹¨', 'í‚¤ë³´ë“œì›Œë¦¬ì–´', 'ê´‘í´ì¥ì¸', 'ì¦ê²œìœ ì €', 'íŒ¨ë°°ì˜ì•„ì´ì½˜', 'ìŠ¹ë¦¬ì˜ìš”ì •', 'ë²„ìŠ¤ê¸°ì‚¬ë‹˜', 'íŠ¸ë¡¤ëŸ¬ì•„ë‹˜', 'ì¬ëŠ¥ì¶©', 'ë…¸ë ¥íŒŒê²Œì´ë¨¸', 'í”¼ì§€ì»¬ì²œì¬', 'ë‡Œì§€ì»¬í”Œë ˆì´ì–´', 'íŒì½˜ê°', 'ì´íŒë§Œí•˜ê³ ì”ë‹¤', 'ì—„ë§ˆëª°ë˜ê²œì¤‘', 'PCë°©ì£½ëŒì´', 'ì¸ìƒì€ì‹¤ì „', 'ê²œìƒê²œì‚¬', 'ì‹œê°„ì˜ì§€ë°°ì', 'íƒ€ì„ì–´íƒê³ ìˆ˜', 'ì „ê´‘ì„í™”', 'ë°”ëŒì˜ìƒì²˜', 'ë¹›ì˜ì†ë„', 'ë¬´ì ì˜ë°©íŒ¨', 'ì ˆëŒ€ì§€ì¡´', 'ì²œìƒê³„ìœ ì €', 'ì‹¬í•´íƒí—˜ê°€', 'í˜‘ê³¡ì˜ì£¼ì¸', 'ì‚¬ë§‰ì˜í­í’', 'ì–¼ìŒì˜ì‹¬ì¥', 'ë¶ˆê½ƒì˜ì˜í˜¼', 'ëŒ€ì§€ì˜ìˆ˜í˜¸ì', 'ë²ˆê°œì˜êµ°ì£¼', 'ì–´ë‘ ì˜ì¶”ê²©ì', 'ë¹›ì˜ì‹¬íŒì', 'ê°•ì² ì˜ì˜ì§€', 'ì•¼ìƒì˜í¬íš¨', 'ê³ ë…í•œëŠ‘ëŒ€', 'ë‚ ë µí•œí‘œë²”', 'ì§€í˜œë¡œìš´ì˜¬ë¹¼ë¯¸', 'ìš©ê°í•œì‚¬ì', 'êµí™œí•œì—¬ìš°', 'ì€ë°€í•œì‚´ì¾¡ì´', 'ê°•ë ¥í•œê³°', 'í•˜ëŠ˜ì˜ë§¤', 'ë°”ë‹¤ì˜ìƒì–´', 'ì „ì¥ì˜ì§€íœ˜ê´€', 'ìµœê³ ì˜ì „ëµê°€', 'ë¬´íŒ¨ì˜ì±”í”¼ì–¸', 'ë– ì˜¤ë¥´ëŠ”ìƒ›ë³„', 'ìˆ¨ì€ê³ ìˆ˜', 'ê²Œì„ë¶„ì„ê°€', 'ì»¨íŠ¸ë¡¤ì˜ì‹ ', 'íƒ€ì´ë°ì˜ê·€ì¬', 'ì—­ì „ì˜ëª…ìˆ˜', 'ìœ„ê¸°ê´€ë¦¬ëŠ¥ë ¥ì', 'ìŠˆí¼í”Œë ˆì´', 'í•˜ë“œìºë¦¬', 'ëª…ì˜ˆë¡œìš´ì£½ìŒ', 'ë¶ˆì‚¬ì¡°', 'ê´‘ì „ì‚¬', 'ìˆ˜í˜¸ê¸°ì‚¬', 'ì‹ ì„±ë§ˆë²•ì‚¬', 'í‘ë§ˆë²•ì‚¬', 'ëƒ‰ê¸°ë§ˆë²•ì‚¬', 'í™”ì—¼ë§ˆë²•ì‚¬', 'ìì—°ì˜ë²—', 'ë™ë¬¼ì¡°ë ¨ì‚¬', 'ê¸°ê³„ê³µí•™ì', 'ì—°ê¸ˆìˆ ì‚¬', 'ë³´ë¬¼ì‚¬ëƒ¥ê¾¼', 'ìœ ë ¹ì„ ì¥', 'ìš°ì£¼ë¹„í–‰ì‚¬', 'ì‚¬ì´ë³´ê·¸ì „ì‚¬', 'ì´ˆëŠ¥ë ¥ì', 'ë‹Œìë§ˆìŠ¤í„°', 'ì‚¬ë¬´ë¼ì´í˜¼', 'ë°”ì´í‚¹ì˜í›„ì˜ˆ', 'ë¡œë§ˆê²€íˆ¬ì‚¬', 'ìŠ¤íŒŒë¥´íƒ€ìš©ì‚¬', 'ì‹œê°„ì—¬í–‰ì', 'ì°¨ì›ë°©ë‘ì', 'ë¯¸ë˜ì˜í¬ë§', 'ê³¼ê±°ì˜ìœ ë ¹', 'ì „ì„¤ì†ì¸ë¬¼', 'ì´ì•¼ê¸°ì£¼ì¸ê³µ', 'ì„¸ê³„ë¥¼êµ¬í•œì', 'ì•…ë‹¹ì˜ì§€ë°°ì', 'ì •ì˜ì˜ì‚¬ë„', 'í˜¼ëˆì˜ì‚¬ì ˆ', 'ê²Œìœ¼ë¥¸ì²œì¬', 'ì ìëŠ”ì‚¬ì', 'ë¨¹ë³´ìš”ì •', 'ìˆ˜ë‹¤ìŸì´ë“œì›Œí”„', 'ì¶¤ì¶”ëŠ”ì˜¤í¬', 'ë…¸ë˜í•˜ëŠ”ì—˜í”„', 'ì±…ì½ëŠ”ë§ˆë²•ì‚¬', 'ìš”ë¦¬ì‚¬íŠ¸ë¡¤', 'ë†ë¶€ì˜¤ìš°ê±°', 'ë‚šì‹œê¾¼ê³ ë¸”ë¦°', 'ë§ì—†ëŠ”ì•”ì‚´ì', 'ì›ƒëŠ”ê´‘ëŒ€', 'ìŠ¬í”ˆìŒìœ ì‹œì¸', 'ë¶„ë…¸í•œì•¼ë§Œì¸', 'í‰í™”ì£¼ì˜ì', 'ì „ìŸê´‘', 'ë°©ë‘ê²€ê°', 'ê¶ì¤‘ë§ˆìˆ ì‚¬', 'ê±°ë¦¬ì˜ë¬´ë²•ì', 'ì™•êµ­ì˜ê¸°ì‚¬', 'í˜ëª…ê°€', 'ë³´ìˆ˜ì£¼ì˜ì', 'íƒí—˜ê°€', 'ë°œëª…ê°€', 'ì˜ˆìˆ ê°€', 'ê³¼í•™ì', 'ì² í•™ì', 'ì‹œì¸', 'ì†Œì„¤ê°€', 'ìŒì•…ê°€', 'í™”ê°€', 'ì¡°ê°ê°€', 'ë‚˜ëŠ”ì•¼íƒ±ì»¤', 'ì¼ë‹¨ëŒê²©', 'ë’¤ë¥¼ë¶€íƒí•´', 'ë§ˆë‚˜ê°€ë¶€ì¡±í•´', 'ìŠ¤í‚¬ì¿¨íƒ€ì„', 'ê¶ê·¹ê¸°ëŒ€ê¸°ì¤‘', 'í¬ì…˜ì´í•„ìš”í•´', 'ì¥ë¹„ìˆ˜ë¦¬ì¤‘', 'í€˜ìŠ¤íŠ¸ì™„ë£Œ', 'ë ˆë²¨ì—…', 'ìµœì¢…ë³´ìŠ¤', 'ì¤‘ê°„ë³´ìŠ¤', 'íˆë“ ë³´ìŠ¤', 'ì—˜ë¦¬íŠ¸ëª¬ìŠ¤í„°', 'ì¡ëª¹ë‹´ë‹¹', 'ì•„ì´í…œíŒŒë°', 'ê³¨ë“œëŸ¬ì‹œ', 'ê°•í™”ì„±ê³µ', 'ê°•í™”ì‹¤íŒ¨', 'ë½‘ê¸°ëŒ€ë°•', 'ë½‘ê¸°ìª½ë°•'];

            // --- ì‚¬ìš´ë“œ ì„¤ì • ---
            const synth = new Tone.Synth().toDestination();
            const sounds = {
                playTurnStart: () => { if(!isMuted) synth.triggerAttackRelease("C5", "8n", Tone.now()); },
                playTick: () => { if(!isMuted) synth.triggerAttackRelease("C4", "16n", Tone.now()); },
                playBonus: () => { if(!isMuted) synth.triggerAttackRelease("G5", "8n", Tone.now() + 0.1); },
                playElimination: () => { if(!isMuted) synth.triggerAttackRelease("A3", "4n", Tone.now()); },
                playGameOver: () => { if(!isMuted) { synth.triggerAttackRelease("C6", "8n", Tone.now()); synth.triggerAttackRelease("G5", "8n", Tone.now() + 0.2); synth.triggerAttackRelease("E5", "8n", Tone.now() + 0.4); } }
            };

            // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
            addUserBtn.addEventListener('click', handleAddUserClick);
            newUserInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleAddUserClick(); });
            startTimerBtn.addEventListener('click', initializeGame);
            nextTurnBtn.addEventListener('click', () => { if (isTimerRunning) { recordTime(); moveToNextUser(); } });
            startTurnBtn.addEventListener('click', startTurn);
            endGameBtn.addEventListener('click', showScoreInputModal);
            viewSummaryBtn.addEventListener('click', showScoreInputModal);
            resetGameBtn.addEventListener('click', resetAll);
            saveImageBtn.addEventListener('click', saveSummaryAsImage);
            muteBtn.addEventListener('click', toggleMute);
            modalConfirmBtn.addEventListener('click', handleModalConfirm);
            modalCancelBtn.addEventListener('click', hideNicknameModal);
            showSummaryFromScoresBtn.addEventListener('click', handleShowSummaryFromScores);

            // --- í•¨ìˆ˜ ---
            function handleAddUserClick() {
                const name = newUserInput.value.trim();
                const color = newUserColorInput.value;
                if (name) {
                    addNewPlayer(name, color);
                } else {
                    showNicknameModal();
                }
            }

            function addNewPlayer(name, color, fromModal = false) {
                const nameExists = users.some(u => u.name === name);
                const colorExists = users.some(u => u.color === color);
                let error = '';

                if (nameExists) error = 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.';
                else if (colorExists) error = 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ìƒ‰ìƒì…ë‹ˆë‹¤.';
                else if (users.length >= 100) error = 'í”Œë ˆì´ì–´ëŠ” ìµœëŒ€ 100ëª…ê¹Œì§€ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';

                if (error) {
                    if (fromModal) modalErrorMsg.textContent = error;
                    else alert(error);
                    return false;
                }

                users.push({ name, color, extraTime: 0, lapTimes: [], isEliminated: false, score: 0 });
                newUserInput.value = '';
                newUserColorInput.value = getUnusedColor();
                renderUserList();
                updateStartButtonState();
                return true;
            }

            function showNicknameModal() {
                modalErrorMsg.textContent = '';
                modalNicknameInput.value = '';
                modalUserColorInput.value = getUnusedColor();
                
                const suggestions = getRandomNicknames(3);
                nicknameSuggestions.innerHTML = suggestions.map(nick => 
                    `<button class="w-full bg-slate-100 text-slate-700 px-3 py-2 rounded-lg font-semibold hover:bg-slate-200 text-sm truncate">${nick}</button>`
                ).join('');
                
                nicknameSuggestions.querySelectorAll('button').forEach(btn => {
                    btn.addEventListener('click', () => {
                        modalNicknameInput.value = btn.textContent;
                    });
                });

                nicknameModal.classList.remove('hidden');
            }

            function hideNicknameModal() {
                nicknameModal.classList.add('hidden');
            }

            function handleModalConfirm() {
                const name = modalNicknameInput.value.trim();
                const color = modalUserColorInput.value;
                if (!name) {
                    modalErrorMsg.textContent = 'ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ê±°ë‚˜ ì„ íƒí•´ì£¼ì„¸ìš”.';
                    return;
                }
                if (addNewPlayer(name, color, true)) {
                    hideNicknameModal();
                }
            }

            function getUnusedColor() {
                const usedColors = users.map(u => u.color);
                const availableColors = COLOR_PALETTE.filter(c => !usedColors.includes(c));
                if (availableColors.length > 0) {
                    return availableColors[0];
                }
                let randomColor;
                do {
                    randomColor = '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
                } while (usedColors.includes(randomColor));
                return randomColor;
            }

            function getRandomNicknames(count) {
                const availableNicknames = NICKNAMES.filter(nick => !users.some(user => user.name === nick));
                const shuffled = availableNicknames.sort(() => 0.5 - Math.random());
                return shuffled.slice(0, count);
            }

            function renderUserList() {
                userListDiv.innerHTML = users.map((user, index) => `
                    <div class="flex justify-between items-center bg-slate-100 p-2 rounded-lg">
                        <div class="flex items-center gap-3">
                            <span class="w-5 h-5 rounded-full" style="background-color: ${user.color};"></span>
                            <span class="text-slate-700">${user.name}</span>
                        </div>
                        <button data-index="${index}" class="remove-user-btn text-red-500 hover:text-red-700 font-bold">X</button>
                    </div>
                `).join('');
                document.querySelectorAll('.remove-user-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        users.splice(parseInt(e.target.dataset.index), 1);
                        renderUserList();
                        updateStartButtonState();
                    });
                });
            }

            function updateStartButtonState() {
                startTimerBtn.disabled = users.length < 1;
            }

            function initializeGame() {
                settingsView.classList.add('hidden');
                timerView.classList.remove('hidden');
                gameOverModal.classList.add('hidden');
                hideLapDetails();

                gameName = gameNameInput.value.trim() || "ì˜¤ëŠ˜ì˜ ê²Œì„";
                turnTime = parseInt(turnTimeInput.value);
                const extraTime = parseInt(extraTimeInput.value);
                isSuddenDeathActive = false;

                users.forEach(user => {
                    user.extraTime = extraTime;
                    user.lapTimes = [];
                    user.isEliminated = false;
                    user.score = 0;
                });
                
                currentUserIndex = 0;
                updateUIForCurrentUser();
                renderLeaderboard();
                
                nextTurnBtn.classList.add('hidden');
                startTurnBtn.classList.remove('hidden');
                startTotalGameTimer();
            }

            function startTotalGameTimer() {
                totalSecondsElapsed = 0;
                updateTotalGameTimeDisplay();
                totalGameTimeInterval = setInterval(() => {
                    totalSecondsElapsed++;
                    updateTotalGameTimeDisplay();
                }, 1000);
            }

            function updateTotalGameTimeDisplay() {
                totalGameTimeEl.textContent = formatTime(totalSecondsElapsed);
            }

            function startTurn() {
                startTurnBtn.classList.add('hidden');
                nextTurnBtn.classList.remove('hidden');
                nextTurnBtn.disabled = false;
                startTimer();
            }

            function startTimer() {
                if (isTimerRunning) return;
                isTimerRunning = true;
                turnStartTime = Date.now();
                timeLeft = turnTime;
                isExtraTimeActive = false;
                sounds.playTurnStart();
                
                timerInterval = setInterval(() => {
                    timeLeft--;
                    updateTimerDisplay(timeLeft);
                    updateProgressRing(timeLeft, turnTime);

                    if (timeLeft <= 5) sounds.playTick();
                    
                    if (timeLeft <= 10 && !isExtraTimeActive) {
                        timerRingContainer.classList.add('time-warning');
                        setTimerColor(COLORS.WARNING);
                    }
                    if (timeLeft <= 5 && !isExtraTimeActive) {
                        timerRingContainer.classList.add('time-critical');
                    }

                    if (timeLeft <= 0) {
                        const currentUser = users[currentUserIndex];
                        if (!isExtraTimeActive && currentUser.extraTime > 0) {
                            currentUser.lapTimes.push(turnTime);
                            isExtraTimeActive = true;
                            timeLeft = currentUser.extraTime;
                            currentUser.turnStartExtraTime = currentUser.extraTime;
                            
                            timerRingContainer.classList.remove('time-warning', 'time-critical');
                            setTimerColor(COLORS.EXTRA);
                            extraTimeIndicator.classList.remove('hidden');
                        } else {
                            recordTime();
                            if (suddenDeathModeCheckbox.checked && isSuddenDeathActive) {
                                eliminatePlayer();
                            } else {
                                moveToNextUser();
                            }
                        }
                    }
                }, 1000);
            }

            function eliminatePlayer() {
                sounds.playElimination();
                const currentUser = users[currentUserIndex];
                currentUser.isEliminated = true;
                showNotification(`${currentUser.name} íƒˆë½!`, 'bg-red-500', 'text-white');
                
                const remainingPlayers = users.filter(u => !u.isEliminated);
                if (remainingPlayers.length <= 1) {
                    endGame(remainingPlayers[0]);
                } else {
                    moveToNextUser();
                }
            }

            function endGame(winner) {
                stopTimer(true);
                sounds.playGameOver();
                winnerNameEl.textContent = winner ? winner.name : "ìŠ¹ì ì—†ìŒ";
                gameOverModal.style.display = 'flex';
                setTimeout(() => gameOverModal.querySelector('div').classList.remove('scale-95'), 10);
            }
            
            function showScoreInputModal() {
                stopTimer(true);
                gameOverModal.style.display = 'none';

                scoreInputList.innerHTML = users.map(user => `
                    <div class="flex justify-between items-center">
                        <span class="font-semibold" style="color: ${user.color};">${user.name}</span>
                        <input type="number" value="0" class="score-input w-24 text-center border rounded-md p-1" data-name="${user.name}">
                    </div>
                `).join('');
                scoreInputModal.classList.remove('hidden');
            }

            function handleShowSummaryFromScores() {
                document.querySelectorAll('.score-input').forEach(input => {
                    const userName = input.dataset.name;
                    const score = parseInt(input.value) || 0;
                    const user = users.find(u => u.name === userName);
                    if (user) {
                        user.score = score;
                    }
                });
                scoreInputModal.classList.add('hidden');
                showSummary();
            }

            function showSummary() {
                summaryGameName.textContent = gameName;
                summaryTotalTime.textContent = formatTime(totalSecondsElapsed);

                users.sort((a, b) => b.score - a.score);

                summaryPlayerList.innerHTML = users.map((user, index) => `
                    <div class="flex justify-between items-center p-3 rounded-lg ${user.isEliminated ? 'bg-slate-100' : ''}">
                        <div class="flex items-center gap-3">
                            <span class="font-bold text-lg w-6 text-center" style="color: ${user.color};">${index + 1}</span>
                            <span class="font-semibold">${user.name}</span>
                        </div>
                        <div class="flex items-center gap-4">
                            <span class="font-mono font-semibold text-slate-500 text-sm">ì†Œìš”ì‹œê°„: ${formatTime(user.totalTimeUsed)}</span>
                            <span class="font-mono font-bold text-lg">${user.score}ì </span>
                        </div>
                    </div>
                `).join('');

                summaryModal.classList.remove('hidden');
            }

            function saveSummaryAsImage() {
                const button = saveImageBtn;
                button.textContent = 'ì €ì¥ ì¤‘...';
                button.disabled = true;
                
                html2canvas(summaryContent, {
                    useCORS: true,
                    backgroundColor: '#ffffff',
                    scale: 2, 
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `${gameName}_ê²°ê³¼.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    button.textContent = 'ì´ë¯¸ì§€ë¡œ ì €ì¥';
                    button.disabled = false;
                }).catch(err => {
                    console.error('ì´ë¯¸ì§€ ì €ì¥ ì˜¤ë¥˜:', err);
                    alert('ì´ë¯¸ì§€ë¥¼ ì €ì¥í•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ë³´ì•ˆ ì„¤ì •(iframe) ë•Œë¬¸ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                    button.textContent = 'ì´ë¯¸ì§€ë¡œ ì €ì¥';
                    button.disabled = false;
                });
            }


            function recordTime() {
                stopTimer();
                const currentUser = users[currentUserIndex];
                const timeUsedThisTurn = (Date.now() - turnStartTime) / 1000;

                if (quickTurnBonusCheckbox.checked && timeUsedThisTurn <= parseInt(bonusConditionTimeInput.value)) {
                    const bonusTime = parseInt(bonusRewardTimeInput.value);
                    currentUser.extraTime += bonusTime;
                    sounds.playBonus();
                    showNotification(`+${bonusTime}ì´ˆ ë³´ë„ˆìŠ¤!`, 'bg-yellow-300', 'text-yellow-800');
                }

                if (isExtraTimeActive) {
                    const extraTimeUsed = currentUser.turnStartExtraTime - Math.max(0, timeLeft);
                    currentUser.lapTimes[currentUser.lapTimes.length - 1] += extraTimeUsed;
                    currentUser.extraTime -= extraTimeUsed;
                } else {
                    currentUser.lapTimes.push(turnTime - Math.max(0, timeLeft));
                }

                if (currentUser.extraTime <= 0) {
                    isSuddenDeathActive = true;
                }
            }

            function movePlayer(index, direction) {
                if (isTimerRunning) {
                    recordTime();
                } else {
                    stopTimer();
                }

                const currentTurnPlayerName = users[currentUserIndex].name;

                if (direction === 'up' && index > 0) {
                    [users[index], users[index - 1]] = [users[index - 1], users[index]];
                } else if (direction === 'down' && index < users.length - 1) {
                    [users[index], users[index + 1]] = [users[index + 1], users[index]];
                }
                
                // ìˆœì„œ ë³€ê²½ í›„, ì´ì „ì— í„´ì„ ì§„í–‰í•˜ë˜ í”Œë ˆì´ì–´ì˜ ìƒˆ ìœ„ì¹˜ë¥¼ ì°¾ìŠµë‹ˆë‹¤.
                currentUserIndex = users.findIndex(u => u.name === currentTurnPlayerName);
                
                updateUIForCurrentUser();
                
                nextTurnBtn.classList.add('hidden');
                nextTurnBtn.disabled = true;
                startTurnBtn.classList.remove('hidden');
            }

            function moveToNextUser() {
                stopTimer();
                if (users.filter(u => !u.isEliminated).length === 0) {
                    endGame(null);
                    return;
                }
                hideLapDetails();
                let nextIndex = (currentUserIndex + 1) % users.length;
                while (users[nextIndex].isEliminated) {
                    nextIndex = (nextIndex + 1) % users.length;
                }
                currentUserIndex = nextIndex;
                
                updateUIForCurrentUser();
                
                nextTurnBtn.classList.add('hidden');
                nextTurnBtn.disabled = true;
                startTurnBtn.classList.remove('hidden');
            }

            function updateUIForCurrentUser() {
                const user = users[currentUserIndex];
                currentUserNameEl.textContent = user.name;
                currentUserNameEl.style.color = user.color;
                currentUserExtraTimeEl.textContent = user.extraTime;
                resetTimerVisuals();
                renderLeaderboard();
            }

            function setTimerColor(color) {
                timerDisplayEl.style.color = color;
                timerProgressRing.style.color = color;
            }

            function resetTimerVisuals() {
                timeLeft = turnTime;
                isExtraTimeActive = false;
                updateTimerDisplay(timeLeft);
                timerRingContainer.classList.remove('time-warning', 'time-critical');
                extraTimeIndicator.classList.add('hidden');
                setTimerColor(users[currentUserIndex].color);
                updateProgressRing(timeLeft, turnTime);
            }

            function renderLeaderboard() {
                leaderboardDiv.innerHTML = '';
                users.forEach((user) => { user.totalTimeUsed = user.lapTimes.reduce((sum, lap) => sum + lap, 0); });
                
                leaderboardDiv.innerHTML = users.map((user, index) => {
                    const isCurrentUser = index === currentUserIndex;
                    const leaderStyle = isCurrentUser ? `box-shadow: 0 0 15px ${user.color}80;` : '';
                    return `
                    <div class="leaderboard-item p-3 rounded-lg border border-slate-200 
                        ${user.isEliminated ? 'eliminated' : 'leaderboard-item-clickable'}" data-name="${user.name}" style="${leaderStyle}">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-3">
                                <span class="font-bold text-lg w-6 text-center" style="color: ${user.color};">${index + 1}</span>
                                <span class="font-semibold">${user.name}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="font-bold" style="color: ${user.color};">${formatTime(user.totalTimeUsed)}</span>
                                <div class="flex flex-col">
                                    <button class="move-btn text-xs ${index === 0 ? 'opacity-20' : ''}" data-index="${index}" data-direction="up" ${index === 0 ? 'disabled' : ''}>â–²</button>
                                    <button class="move-btn text-xs ${index === users.length - 1 ? 'opacity-20' : ''}" data-index="${index}" data-direction="down" ${index === users.length - 1 ? 'disabled' : ''}>â–¼</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `}).join('');

                document.querySelectorAll('.leaderboard-item-clickable').forEach(item => {
                    item.addEventListener('click', handleLeaderboardClick);
                });
                document.querySelectorAll('.move-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const index = parseInt(e.currentTarget.dataset.index);
                        const direction = e.currentTarget.dataset.direction;
                        movePlayer(index, direction);
                    });
                });
            }

            function handleLeaderboardClick(event) {
                const selectedName = event.currentTarget.dataset.name;
                document.querySelectorAll('.leaderboard-item').forEach(item => {
                    item.classList.toggle('selected-leaderboard-item', item.dataset.name === selectedName);
                });
                showLapDetails(selectedName);
            }

            function showLapDetails(userName) {
                const user = users.find(u => u.name === userName);
                if (!user) return;

                lapDetailsTitle.textContent = `${user.name} - ìƒì„¸ ê¸°ë¡`;
                lapDetailsTitle.style.color = user.color;
                if (user.lapTimes.length > 0) {
                    lapDetailsList.innerHTML = user.lapTimes.map((lap, i) => 
                        `<div class="flex justify-between p-2 bg-slate-50 rounded-md">
                            <span>ë© ${i + 1}</span>
                            <span class="font-mono">${formatTime(lap)}</span>
                         </div>`
                    ).join('');
                } else {
                    lapDetailsList.innerHTML = `<p class="text-slate-500">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
                }
                lapDetailsView.classList.remove('hidden');
            }

            function hideLapDetails() {
                lapDetailsView.classList.add('hidden');
                document.querySelectorAll('.leaderboard-item').forEach(item => {
                    item.classList.remove('selected-leaderboard-item');
                });
            }

            function resetAll() {
                stopTimer(true);
                settingsView.classList.remove('hidden');
                timerView.classList.add('hidden');
                gameOverModal.classList.add('hidden');
                summaryModal.classList.add('hidden');
                scoreInputModal.classList.add('hidden');
                hideLapDetails();
                users = [];
                renderUserList();
                updateStartButtonState();
            }

            function toggleMute() {
                isMuted = !isMuted;
                volumeIcon.classList.toggle('hidden', isMuted);
                muteIcon.classList.toggle('hidden', !isMuted);
            }
            
            function showNotification(message, bgColor, textColor) {
                notificationEl.textContent = message;
                notificationEl.className = `absolute top-1/3 left-1/2 -translate-x-1/2 -translate-y-1/2 font-bold px-6 py-3 rounded-full shadow-lg opacity-0 transform scale-50 z-20 ${bgColor} ${textColor}`;
                notificationEl.classList.remove('opacity-0', 'scale-50');
                notificationEl.classList.add('opacity-100', 'scale-100');
                setTimeout(() => {
                    notificationEl.classList.remove('opacity-100', 'scale-100');
                    notificationEl.classList.add('opacity-0', 'scale-50');
                }, 2000);
            }

            function stopTimer(isPermanent = false) {
                clearInterval(timerInterval);
                isTimerRunning = false;
                timerRingContainer.classList.remove('time-warning', 'time-critical');
                if (isPermanent) {
                    clearInterval(totalGameTimeInterval);
                }
            }
            
            function updateTimerDisplay(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                timerDisplayEl.textContent = `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
            }

            function updateProgressRing(currentTime, totalTime) {
                const progress = Math.max(0, currentTime) / totalTime;
                const offset = ringCircumference * (1 - progress);
                timerProgressRing.style.strokeDashoffset = offset;
            }

            function formatTime(seconds) {
                const totalSeconds = Math.round(seconds);
                const mins = Math.floor(totalSeconds / 60);
                const secs = totalSeconds % 60;
                return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
            }

            updateStartButtonState();
        });
    </script>
</body>
</html>
