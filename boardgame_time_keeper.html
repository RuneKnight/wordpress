<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>게임 모드 타이머</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
        #timer-display {
            /* 폰트 크기를 화면 너비에 따라 유동적으로 조절 (최소 3rem, 기본 18vw, 최대 5.5rem) */
            font-size: clamp(3rem, 18vw, 5.5rem);
            line-height: 1;
        }
        .timer-ring-container {
            transition: transform 0.5s ease;
        }
        .time-warning .timer-ring-container { animation: pulse 1s infinite; }
        .time-critical .timer-ring-container { animation: shake 0.5s infinite; }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.03); }
        }
        @keyframes shake {
            0%, 100% { transform: translate(0, 0) rotate(0); }
            25% { transform: translate(2px, -2px) rotate(1deg); }
            50% { transform: translate(-2px, 2px) rotate(-1deg); }
            75% { transform: translate(2px, 2px) rotate(1deg); }
        }
        .leaderboard-item { transition: all 0.3s ease; }
        .leaderboard-item-clickable { cursor: pointer; }
        .current-leader {
             transform: scale(1.05);
        }
        .selected-leaderboard-item {
            background-color: #eef2ff; /* indigo-100 */
            border-color: #818cf8 !important; /* indigo-400 */
            transform: scale(1.05);
        }
        .eliminated {
            opacity: 0.5;
            text-decoration: line-through;
            background-color: #e2e8f0; /* slate-200 */
        }
        #notification {
            transition: opacity 0.5s, transform 0.5s;
        }
        /* 스크롤바 스타일 */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        input[type="color"] {
        	-webkit-appearance: none;
        	border: none;
        	width: 32px;
        	height: 32px;
            cursor: pointer;
            border-radius: 50%;
            overflow: hidden;
        }
        input[type="color"]::-webkit-color-swatch-wrapper {
        	padding: 0;
        }
        input[type="color"]::-webkit-color-swatch {
        	border: none;
            border-radius: 50%;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 flex flex-col items-center min-h-screen p-4">

    <div id="app-container" class="w-full max-w-4xl mx-auto">
        
        <!-- 설정 섹션 -->
        <div id="settings-view" class="bg-white p-6 rounded-2xl shadow-lg mb-6">
            <h1 class="text-3xl font-bold text-center text-blue-600 mb-6">게임 타이머 설정</h1>
            
            <div class="mb-6">
                <label for="game-name-input" class="text-xl font-semibold mb-3 text-slate-700 block">게임 이름</label>
                <input type="text" id="game-name-input" placeholder="오늘의 게임 이름은?" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
            </div>

            <div class="grid md:grid-cols-2 gap-x-8 gap-y-6 border-t pt-6">
                <!-- 플레이어 추가 -->
                <div>
                    <h2 class="text-xl font-semibold mb-3 text-slate-700">1. 플레이어 추가</h2>
                    <div class="flex items-center gap-2">
                        <input type="color" id="new-user-color" value="#3b82f6" title="색상 선택">
                        <input type="text" id="new-user-name" placeholder="플레이어 이름 (1-100명)" class="flex-grow w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        <button id="add-user-btn" class="bg-blue-500 text-white px-6 py-2 rounded-lg font-semibold hover:bg-blue-600 shadow">추가</button>
                    </div>
                    <div id="user-list" class="mt-4 space-y-2 max-h-40 overflow-y-auto pr-2"></div>
                </div>

                <!-- 시간 설정 -->
                <div>
                    <h2 class="text-xl font-semibold mb-3 text-slate-700">2. 시간 설정</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="turn-time" class="block text-sm font-medium text-slate-600">기본 시간 (초)</label>
                            <input type="number" id="turn-time" value="30" min="1" class="w-full mt-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="extra-time" class="block text-sm font-medium text-slate-600">추가 시간 (초)</label>
                            <input type="number" id="extra-time" value="60" min="0" class="w-full mt-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                </div>

                <!-- 게임 모드 설정 -->
                <div class="md:col-span-2 border-t pt-6">
                    <h2 class="text-xl font-semibold mb-4 text-slate-700">3. 게임 모드 설정</h2>
                    <div class="space-y-4">
                        <label class="flex items-center gap-3 p-3 bg-slate-50 rounded-lg">
                            <input type="checkbox" id="sudden-death-mode" class="h-5 w-5 rounded text-blue-600 focus:ring-blue-500">
                            <span class="font-medium">서든데스 모드 활성화</span>
                        </label>
                        <div class="p-3 bg-slate-50 rounded-lg">
                            <label class="flex items-center gap-3">
                                <input type="checkbox" id="quick-turn-bonus-mode" checked class="h-5 w-5 rounded text-blue-600 focus:ring-blue-500">
                                <span class="font-medium">퀵 턴 보너스</span>
                            </label>
                            <div class="text-sm text-slate-500 mt-2 pl-8">
                                턴 시작 후 <input type="number" id="bonus-condition-time" value="5" class="w-16 text-center mx-1 border-b">초 안에 넘기면 추가 시간 <input type="number" id="bonus-reward-time" value="3" class="w-16 text-center mx-1 border-b">초 획득!
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-8 text-center">
                <button id="start-timer-btn" class="bg-green-500 text-white px-10 py-3 rounded-lg font-bold text-lg hover:bg-green-600 shadow-lg disabled:bg-slate-400 disabled:cursor-not-allowed">게임 시작</button>
            </div>
        </div>

        <!-- 타이머 뷰 -->
        <div id="timer-view" class="hidden relative">
            <!-- 음소거 버튼 -->
            <button id="mute-btn" class="absolute top-4 right-4 z-10 p-2 bg-white rounded-full shadow-md">
                <svg id="volume-icon" class="w-6 h-6 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path></svg>
                <svg id="mute-icon" class="w-6 h-6 text-slate-600 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15zM17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2"></path></svg>
            </button>
            <!-- 보너스 알림 -->
            <div id="notification" class="absolute top-1/3 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-yellow-300 text-yellow-800 font-bold px-6 py-3 rounded-full shadow-lg opacity-0 transform scale-50 z-20"></div>

            <div class="grid lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-lg flex flex-col items-center justify-center text-center">
                    <h2 id="current-user-name" class="text-4xl font-bold mb-2">플레이어 이름</h2>
                    <p class="text-slate-500 mb-6">님의 차례입니다</p>
                    
                    <div class="relative w-64 h-64 sm:w-80 sm:h-80 mb-6 timer-ring-container">
                        <svg class="w-full h-full" viewBox="0 0 100 100">
                            <circle class="text-slate-200" stroke-width="8" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" />
                            <circle id="timer-progress-ring" stroke-width="8" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" stroke-linecap="round" transform="rotate(-90 50 50)" style="stroke-dasharray: 282.7; stroke-dashoffset: 282.7;" />
                        </svg>
                        <div id="timer-display-container" class="absolute inset-0 flex flex-col items-center justify-center">
                            <span id="timer-display" class="font-bold">00:00</span>
                            <span id="extra-time-indicator" class="text-amber-500 font-bold text-lg hidden">추가 시간 사용 중</span>
                        </div>
                    </div>
                    
                    <div id="user-extra-time-display" class="mb-6 text-lg">남은 추가 시간: <span id="current-user-extra-time" class="font-bold">0</span>초</div>

                    <div class="w-full px-4 sm:px-0 sm:max-w-xs sm:mx-auto">
                        <button id="next-turn-btn" class="w-full bg-amber-500 text-white px-6 py-4 rounded-lg font-bold text-lg hover:bg-amber-600 shadow-md">차례 넘기기</button>
                        <button id="start-turn-btn" class="w-full bg-blue-500 text-white px-6 py-4 rounded-lg font-bold text-lg hover:bg-blue-600 shadow-md hidden">시작</button>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h3 class="text-2xl font-bold mb-2 text-center">리더보드</h3>
                        <p class="text-center text-sm text-slate-500 mb-4">순서 변경(▲/▼) / 기록 보기(클릭)</p>
                        <div id="leaderboard" class="space-y-3 max-h-80 overflow-y-auto pr-2"></div>
                    </div>

                    <!-- 상세 랩타임 뷰 -->
                    <div id="lap-details-view" class="hidden bg-white p-6 rounded-2xl shadow-lg">
                        <h3 id="lap-details-title" class="text-xl font-bold mb-4 text-center"></h3>
                        <div id="lap-details-list" class="space-y-2 max-h-48 overflow-y-auto pr-2 text-center"></div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-lg text-center">
                        <h3 class="text-2xl font-bold mb-4 text-center">제어판</h3>
                        <button id="end-game-btn" class="w-full bg-red-500 text-white px-6 py-3 rounded-lg font-bold hover:bg-red-600 shadow">게임 종료</button>
                    </div>
                </div>
            </div>
             <div id="total-time-container" class="mt-6 text-center text-xl font-semibold text-slate-600">
                총 진행 시간: <span id="total-game-time">00:00</span>
            </div>
        </div>
        
        <!-- 게임 종료 모달 -->
        <div id="game-over-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
            <div class="bg-white text-center p-10 rounded-2xl shadow-2xl transform transition-all scale-95">
                <h2 class="text-5xl font-bold text-yellow-500 mb-4">🏆 승리 🏆</h2>
                <p id="winner-name" class="text-3xl font-semibold text-slate-800 mb-8"></p>
                <button id="view-summary-btn" class="bg-blue-500 text-white px-8 py-3 rounded-lg font-bold text-lg hover:bg-blue-600">결과 보기</button>
            </div>
        </div>

        <!-- 닉네임 추천 모달 -->
        <div id="nickname-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
            <div class="bg-white w-full max-w-md p-6 rounded-2xl shadow-xl">
                <h2 class="text-2xl font-bold text-center mb-4">플레이어 설정</h2>
                <p class="text-center text-slate-500 mb-6">닉네임과 색상을 설정해주세요.</p>
                
                <div class="flex items-center justify-center gap-4 mb-6">
                    <label for="modal-user-color" class="font-medium text-slate-600">색상:</label>
                    <input type="color" id="modal-user-color" value="#3b82f6" title="색상 선택">
                </div>

                <div class="flex items-center gap-2 mb-4">
                    <input type="text" id="modal-nickname-input" placeholder="원하는 닉네임 입력" class="flex-grow w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div id="nickname-suggestions" class="grid grid-cols-3 gap-2 mb-6">
                </div>
                 <p id="modal-error-msg" class="text-red-500 text-center text-sm mb-4 h-5"></p>
                <div class="flex gap-4">
                    <button id="modal-cancel-btn" class="w-full bg-slate-200 text-slate-700 px-6 py-2 rounded-lg font-semibold hover:bg-slate-300">취소</button>
                    <button id="modal-confirm-btn" class="w-full bg-blue-500 text-white px-6 py-2 rounded-lg font-semibold hover:bg-blue-600">확인</button>
                </div>
            </div>
        </div>
        
        <!-- 점수 입력 모달 -->
        <div id="score-input-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
            <div class="bg-white w-full max-w-md p-6 rounded-2xl shadow-xl">
                <h2 class="text-2xl font-bold text-center mb-4">점수 입력</h2>
                <p class="text-center text-slate-500 mb-6">각 플레이어의 최종 점수를 입력하세요.</p>
                <div id="score-input-list" class="space-y-4 max-h-80 overflow-y-auto pr-2 mb-6">
                    <!-- 점수 입력 필드가 여기에 삽입됩니다 -->
                </div>
                <button id="show-summary-from-scores-btn" class="w-full bg-blue-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-600">결과 보기</button>
            </div>
        </div>

        <!-- 최종 결과 모달 -->
        <div id="summary-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
            <div class="w-full max-w-lg">
                <div id="summary-content" class="bg-white p-8 rounded-2xl shadow-2xl">
                    <h2 id="summary-game-name" class="text-4xl font-bold text-center mb-2">게임 결과</h2>
                    <p class="text-center text-slate-500 mb-6">총 진행 시간: <span id="summary-total-time" class="font-semibold"></span></p>
                    <div id="summary-player-list" class="space-y-3 max-h-80 overflow-y-auto pr-2 border-t pt-4">
                        <!-- 플레이어 결과 목록 -->
                    </div>
                </div>
                <div class="mt-6 flex gap-4">
                    <button id="reset-game-btn" class="w-full bg-blue-500 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-600">새 게임 시작</button>
                    <button id="save-image-btn" class="w-full bg-green-500 text-white px-6 py-3 rounded-lg font-bold hover:bg-green-600">이미지로 저장</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- UI 요소 ---
            const settingsView = document.getElementById('settings-view');
            const timerView = document.getElementById('timer-view');
            const gameNameInput = document.getElementById('game-name-input');
            const newUserInput = document.getElementById('new-user-name');
            const newUserColorInput = document.getElementById('new-user-color');
            const addUserBtn = document.getElementById('add-user-btn');
            const userListDiv = document.getElementById('user-list');
            const turnTimeInput = document.getElementById('turn-time');
            const extraTimeInput = document.getElementById('extra-time');
            const startTimerBtn = document.getElementById('start-timer-btn');
            const currentUserNameEl = document.getElementById('current-user-name');
            const timerDisplayEl = document.getElementById('timer-display');
            const extraTimeIndicator = document.getElementById('extra-time-indicator');
            const currentUserExtraTimeEl = document.getElementById('current-user-extra-time');
            const timerProgressRing = document.getElementById('timer-progress-ring');
            const nextTurnBtn = document.getElementById('next-turn-btn');
            const startTurnBtn = document.getElementById('start-turn-btn');
            const endGameBtn = document.getElementById('end-game-btn');
            const leaderboardDiv = document.getElementById('leaderboard');
            const timerRingContainer = document.querySelector('.timer-ring-container');
            const totalGameTimeEl = document.getElementById('total-game-time');
            const muteBtn = document.getElementById('mute-btn');
            const volumeIcon = document.getElementById('volume-icon');
            const muteIcon = document.getElementById('mute-icon');
            const notificationEl = document.getElementById('notification');
            const gameOverModal = document.getElementById('game-over-modal');
            const winnerNameEl = document.getElementById('winner-name');
            const viewSummaryBtn = document.getElementById('view-summary-btn');
            const lapDetailsView = document.getElementById('lap-details-view');
            const lapDetailsTitle = document.getElementById('lap-details-title');
            const lapDetailsList = document.getElementById('lap-details-list');
            const nicknameModal = document.getElementById('nickname-modal');
            const modalNicknameInput = document.getElementById('modal-nickname-input');
            const modalUserColorInput = document.getElementById('modal-user-color');
            const nicknameSuggestions = document.getElementById('nickname-suggestions');
            const modalConfirmBtn = document.getElementById('modal-confirm-btn');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');
            const modalErrorMsg = document.getElementById('modal-error-msg');
            const scoreInputModal = document.getElementById('score-input-modal');
            const scoreInputList = document.getElementById('score-input-list');
            const showSummaryFromScoresBtn = document.getElementById('show-summary-from-scores-btn');
            const summaryModal = document.getElementById('summary-modal');
            const summaryContent = document.getElementById('summary-content');
            const summaryGameName = document.getElementById('summary-game-name');
            const summaryTotalTime = document.getElementById('summary-total-time');
            const summaryPlayerList = document.getElementById('summary-player-list');
            const resetGameBtn = document.getElementById('reset-game-btn');
            const saveImageBtn = document.getElementById('save-image-btn');

            // --- 게임 설정 UI ---
            const suddenDeathModeCheckbox = document.getElementById('sudden-death-mode');
            const quickTurnBonusCheckbox = document.getElementById('quick-turn-bonus-mode');
            const bonusConditionTimeInput = document.getElementById('bonus-condition-time');
            const bonusRewardTimeInput = document.getElementById('bonus-reward-time');

            // --- 상태 변수 ---
            let users = [];
            let gameName = "게임";
            let currentUserIndex = 0;
            let timerInterval, totalGameTimeInterval;
            let timeLeft, totalSecondsElapsed;
            let turnStartTime;
            let turnTime;
            let isTimerRunning = false;
            let isExtraTimeActive = false;
            let isSuddenDeathActive = false;
            let isMuted = false;
            const ringCircumference = 2 * Math.PI * 45;
            const COLORS = { WARNING: '#f87171', EXTRA: '#fbbf24' };
            const COLOR_PALETTE = ['#3b82f6', '#ef4444', '#22c55e', '#eab308', '#8b5cf6', '#ec4899', '#14b8a6', '#f97316', '#6366f1', '#d946ef', '#0ea5e9', '#84cc16'];
            const NICKNAMES = ['전설의트롤', '만렙주술사', '쪼렙전사', '힐은셀프', '물약상인', '드래곤슬레이어', '엘프궁수', '오크의분노', '그림자암살자', '마법사의제자', '헤드샷장인', '돌격대장', '저격의신', '수류탄투척기', '백업은없다', '무빙의달인', '샷건매니아', '에임의신', '핑계는장비탓', '최후의생존자', '오더는내가지휘한다', '미드오픈', '정글의지배자', '탑신병자', '바텀듀오', '한타의귀재', '운영의마술사', '맵핵의심유저', '캐리머신', '성장의대가', '게임은장비빨', '키보드워리어', '광클장인', '즐겜유저', '패배의아이콘', '승리의요정', '버스기사님', '트롤러아님', '재능충', '노력파게이머', '피지컬천재', '뇌지컬플레이어', '팝콘각', '이판만하고잔다', '엄마몰래겜중', 'PC방죽돌이', '인생은실전', '겜생겜사', '시간의지배자', '타임어택고수', '전광석화', '바람의상처', '빛의속도', '무적의방패', '절대지존', '천상계유저', '심해탐험가', '협곡의주인', '사막의폭풍', '얼음의심장', '불꽃의영혼', '대지의수호자', '번개의군주', '어둠의추격자', '빛의심판자', '강철의의지', '야생의포효', '고독한늑대', '날렵한표범', '지혜로운올빼미', '용감한사자', '교활한여우', '은밀한살쾡이', '강력한곰', '하늘의매', '바다의상어', '전장의지휘관', '최고의전략가', '무패의챔피언', '떠오르는샛별', '숨은고수', '게임분석가', '컨트롤의신', '타이밍의귀재', '역전의명수', '위기관리능력자', '슈퍼플레이', '하드캐리', '명예로운죽음', '불사조', '광전사', '수호기사', '신성마법사', '흑마법사', '냉기마법사', '화염마법사', '자연의벗', '동물조련사', '기계공학자', '연금술사', '보물사냥꾼', '유령선장', '우주비행사', '사이보그전사', '초능력자', '닌자마스터', '사무라이혼', '바이킹의후예', '로마검투사', '스파르타용사', '시간여행자', '차원방랑자', '미래의희망', '과거의유령', '전설속인물', '이야기주인공', '세계를구한자', '악당의지배자', '정의의사도', '혼돈의사절', '게으른천재', '잠자는사자', '먹보요정', '수다쟁이드워프', '춤추는오크', '노래하는엘프', '책읽는마법사', '요리사트롤', '농부오우거', '낚시꾼고블린', '말없는암살자', '웃는광대', '슬픈음유시인', '분노한야만인', '평화주의자', '전쟁광', '방랑검객', '궁중마술사', '거리의무법자', '왕국의기사', '혁명가', '보수주의자', '탐험가', '발명가', '예술가', '과학자', '철학자', '시인', '소설가', '음악가', '화가', '조각가', '나는야탱커', '일단돌격', '뒤를부탁해', '마나가부족해', '스킬쿨타임', '궁극기대기중', '포션이필요해', '장비수리중', '퀘스트완료', '레벨업', '최종보스', '중간보스', '히든보스', '엘리트몬스터', '잡몹담당', '아이템파밍', '골드러시', '강화성공', '강화실패', '뽑기대박', '뽑기쪽박'];

            // --- 사운드 설정 ---
            const synth = new Tone.Synth().toDestination();
            const sounds = {
                playTurnStart: () => { if(!isMuted) synth.triggerAttackRelease("C5", "8n", Tone.now()); },
                playTick: () => { if(!isMuted) synth.triggerAttackRelease("C4", "16n", Tone.now()); },
                playBonus: () => { if(!isMuted) synth.triggerAttackRelease("G5", "8n", Tone.now() + 0.1); },
                playElimination: () => { if(!isMuted) synth.triggerAttackRelease("A3", "4n", Tone.now()); },
                playGameOver: () => { if(!isMuted) { synth.triggerAttackRelease("C6", "8n", Tone.now()); synth.triggerAttackRelease("G5", "8n", Tone.now() + 0.2); synth.triggerAttackRelease("E5", "8n", Tone.now() + 0.4); } }
            };

            // --- 이벤트 리스너 ---
            addUserBtn.addEventListener('click', handleAddUserClick);
            newUserInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleAddUserClick(); });
            startTimerBtn.addEventListener('click', initializeGame);
            nextTurnBtn.addEventListener('click', () => { if (isTimerRunning) { recordTime(); moveToNextUser(); } });
            startTurnBtn.addEventListener('click', startTurn);
            endGameBtn.addEventListener('click', showScoreInputModal);
            viewSummaryBtn.addEventListener('click', showScoreInputModal);
            resetGameBtn.addEventListener('click', resetAll);
            saveImageBtn.addEventListener('click', saveSummaryAsImage);
            muteBtn.addEventListener('click', toggleMute);
            modalConfirmBtn.addEventListener('click', handleModalConfirm);
            modalCancelBtn.addEventListener('click', hideNicknameModal);
            showSummaryFromScoresBtn.addEventListener('click', handleShowSummaryFromScores);

            // --- 함수 ---
            function handleAddUserClick() {
                const name = newUserInput.value.trim();
                const color = newUserColorInput.value;
                if (name) {
                    addNewPlayer(name, color);
                } else {
                    showNicknameModal();
                }
            }

            function addNewPlayer(name, color, fromModal = false) {
                const nameExists = users.some(u => u.name === name);
                const colorExists = users.some(u => u.color === color);
                let error = '';

                if (nameExists) error = '이미 사용 중인 닉네임입니다.';
                else if (colorExists) error = '이미 사용 중인 색상입니다.';
                else if (users.length >= 100) error = '플레이어는 최대 100명까지 추가할 수 있습니다.';

                if (error) {
                    if (fromModal) modalErrorMsg.textContent = error;
                    else alert(error);
                    return false;
                }

                users.push({ name, color, extraTime: 0, lapTimes: [], isEliminated: false, score: 0 });
                newUserInput.value = '';
                newUserColorInput.value = getUnusedColor();
                renderUserList();
                updateStartButtonState();
                return true;
            }

            function showNicknameModal() {
                modalErrorMsg.textContent = '';
                modalNicknameInput.value = '';
                modalUserColorInput.value = getUnusedColor();
                
                const suggestions = getRandomNicknames(3);
                nicknameSuggestions.innerHTML = suggestions.map(nick => 
                    `<button class="w-full bg-slate-100 text-slate-700 px-3 py-2 rounded-lg font-semibold hover:bg-slate-200 text-sm truncate">${nick}</button>`
                ).join('');
                
                nicknameSuggestions.querySelectorAll('button').forEach(btn => {
                    btn.addEventListener('click', () => {
                        modalNicknameInput.value = btn.textContent;
                    });
                });

                nicknameModal.classList.remove('hidden');
            }

            function hideNicknameModal() {
                nicknameModal.classList.add('hidden');
            }

            function handleModalConfirm() {
                const name = modalNicknameInput.value.trim();
                const color = modalUserColorInput.value;
                if (!name) {
                    modalErrorMsg.textContent = '닉네임을 입력하거나 선택해주세요.';
                    return;
                }
                if (addNewPlayer(name, color, true)) {
                    hideNicknameModal();
                }
            }

            function getUnusedColor() {
                const usedColors = users.map(u => u.color);
                const availableColors = COLOR_PALETTE.filter(c => !usedColors.includes(c));
                if (availableColors.length > 0) {
                    return availableColors[0];
                }
                let randomColor;
                do {
                    randomColor = '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
                } while (usedColors.includes(randomColor));
                return randomColor;
            }

            function getRandomNicknames(count) {
                const availableNicknames = NICKNAMES.filter(nick => !users.some(user => user.name === nick));
                const shuffled = availableNicknames.sort(() => 0.5 - Math.random());
                return shuffled.slice(0, count);
            }

            function renderUserList() {
                userListDiv.innerHTML = users.map((user, index) => `
                    <div class="flex justify-between items-center bg-slate-100 p-2 rounded-lg">
                        <div class="flex items-center gap-3">
                            <span class="w-5 h-5 rounded-full" style="background-color: ${user.color};"></span>
                            <span class="text-slate-700">${user.name}</span>
                        </div>
                        <button data-index="${index}" class="remove-user-btn text-red-500 hover:text-red-700 font-bold">X</button>
                    </div>
                `).join('');
                document.querySelectorAll('.remove-user-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        users.splice(parseInt(e.target.dataset.index), 1);
                        renderUserList();
                        updateStartButtonState();
                    });
                });
            }

            function updateStartButtonState() {
                startTimerBtn.disabled = users.length < 1;
            }

            function initializeGame() {
                settingsView.classList.add('hidden');
                timerView.classList.remove('hidden');
                gameOverModal.classList.add('hidden');
                hideLapDetails();

                gameName = gameNameInput.value.trim() || "오늘의 게임";
                turnTime = parseInt(turnTimeInput.value);
                const extraTime = parseInt(extraTimeInput.value);
                isSuddenDeathActive = false;

                users.forEach(user => {
                    user.extraTime = extraTime;
                    user.lapTimes = [];
                    user.isEliminated = false;
                    user.score = 0;
                });
                
                currentUserIndex = 0;
                updateUIForCurrentUser();
                renderLeaderboard();
                
                nextTurnBtn.classList.add('hidden');
                startTurnBtn.classList.remove('hidden');
                startTotalGameTimer();
            }

            function startTotalGameTimer() {
                totalSecondsElapsed = 0;
                updateTotalGameTimeDisplay();
                totalGameTimeInterval = setInterval(() => {
                    totalSecondsElapsed++;
                    updateTotalGameTimeDisplay();
                }, 1000);
            }

            function updateTotalGameTimeDisplay() {
                totalGameTimeEl.textContent = formatTime(totalSecondsElapsed);
            }

            function startTurn() {
                startTurnBtn.classList.add('hidden');
                nextTurnBtn.classList.remove('hidden');
                nextTurnBtn.disabled = false;
                startTimer();
            }

            function startTimer() {
                if (isTimerRunning) return;
                isTimerRunning = true;
                turnStartTime = Date.now();
                timeLeft = turnTime;
                isExtraTimeActive = false;
                sounds.playTurnStart();
                
                timerInterval = setInterval(() => {
                    timeLeft--;
                    updateTimerDisplay(timeLeft);
                    updateProgressRing(timeLeft, turnTime);

                    if (timeLeft <= 5) sounds.playTick();
                    
                    if (timeLeft <= 10 && !isExtraTimeActive) {
                        timerRingContainer.classList.add('time-warning');
                        setTimerColor(COLORS.WARNING);
                    }
                    if (timeLeft <= 5 && !isExtraTimeActive) {
                        timerRingContainer.classList.add('time-critical');
                    }

                    if (timeLeft <= 0) {
                        const currentUser = users[currentUserIndex];
                        if (!isExtraTimeActive && currentUser.extraTime > 0) {
                            currentUser.lapTimes.push(turnTime);
                            isExtraTimeActive = true;
                            timeLeft = currentUser.extraTime;
                            currentUser.turnStartExtraTime = currentUser.extraTime;
                            
                            timerRingContainer.classList.remove('time-warning', 'time-critical');
                            setTimerColor(COLORS.EXTRA);
                            extraTimeIndicator.classList.remove('hidden');
                        } else {
                            recordTime();
                            if (suddenDeathModeCheckbox.checked && isSuddenDeathActive) {
                                eliminatePlayer();
                            } else {
                                moveToNextUser();
                            }
                        }
                    }
                }, 1000);
            }

            function eliminatePlayer() {
                sounds.playElimination();
                const currentUser = users[currentUserIndex];
                currentUser.isEliminated = true;
                showNotification(`${currentUser.name} 탈락!`, 'bg-red-500', 'text-white');
                
                const remainingPlayers = users.filter(u => !u.isEliminated);
                if (remainingPlayers.length <= 1) {
                    endGame(remainingPlayers[0]);
                } else {
                    moveToNextUser();
                }
            }

            function endGame(winner) {
                stopTimer(true);
                sounds.playGameOver();
                winnerNameEl.textContent = winner ? winner.name : "승자 없음";
                gameOverModal.style.display = 'flex';
                setTimeout(() => gameOverModal.querySelector('div').classList.remove('scale-95'), 10);
            }
            
            function showScoreInputModal() {
                stopTimer(true);
                gameOverModal.style.display = 'none';

                scoreInputList.innerHTML = users.map(user => `
                    <div class="flex justify-between items-center">
                        <span class="font-semibold" style="color: ${user.color};">${user.name}</span>
                        <input type="number" value="0" class="score-input w-24 text-center border rounded-md p-1" data-name="${user.name}">
                    </div>
                `).join('');
                scoreInputModal.classList.remove('hidden');
            }

            function handleShowSummaryFromScores() {
                document.querySelectorAll('.score-input').forEach(input => {
                    const userName = input.dataset.name;
                    const score = parseInt(input.value) || 0;
                    const user = users.find(u => u.name === userName);
                    if (user) {
                        user.score = score;
                    }
                });
                scoreInputModal.classList.add('hidden');
                showSummary();
            }

            function showSummary() {
                summaryGameName.textContent = gameName;
                summaryTotalTime.textContent = formatTime(totalSecondsElapsed);

                users.sort((a, b) => b.score - a.score);

                summaryPlayerList.innerHTML = users.map((user, index) => `
                    <div class="flex justify-between items-center p-3 rounded-lg ${user.isEliminated ? 'bg-slate-100' : ''}">
                        <div class="flex items-center gap-3">
                            <span class="font-bold text-lg w-6 text-center" style="color: ${user.color};">${index + 1}</span>
                            <span class="font-semibold">${user.name}</span>
                        </div>
                        <div class="flex items-center gap-4">
                            <span class="font-mono font-semibold text-slate-500 text-sm">소요시간: ${formatTime(user.totalTimeUsed)}</span>
                            <span class="font-mono font-bold text-lg">${user.score}점</span>
                        </div>
                    </div>
                `).join('');

                summaryModal.classList.remove('hidden');
            }

            function saveSummaryAsImage() {
                const button = saveImageBtn;
                button.textContent = '저장 중...';
                button.disabled = true;
                
                html2canvas(summaryContent, {
                    useCORS: true,
                    backgroundColor: '#ffffff',
                    scale: 2, 
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `${gameName}_결과.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    button.textContent = '이미지로 저장';
                    button.disabled = false;
                }).catch(err => {
                    console.error('이미지 저장 오류:', err);
                    alert('이미지를 저장하는 데 실패했습니다. 브라우저 보안 설정(iframe) 때문일 수 있습니다.');
                    button.textContent = '이미지로 저장';
                    button.disabled = false;
                });
            }


            function recordTime() {
                stopTimer();
                const currentUser = users[currentUserIndex];
                const timeUsedThisTurn = (Date.now() - turnStartTime) / 1000;

                if (quickTurnBonusCheckbox.checked && timeUsedThisTurn <= parseInt(bonusConditionTimeInput.value)) {
                    const bonusTime = parseInt(bonusRewardTimeInput.value);
                    currentUser.extraTime += bonusTime;
                    sounds.playBonus();
                    showNotification(`+${bonusTime}초 보너스!`, 'bg-yellow-300', 'text-yellow-800');
                }

                if (isExtraTimeActive) {
                    const extraTimeUsed = currentUser.turnStartExtraTime - Math.max(0, timeLeft);
                    currentUser.lapTimes[currentUser.lapTimes.length - 1] += extraTimeUsed;
                    currentUser.extraTime -= extraTimeUsed;
                } else {
                    currentUser.lapTimes.push(turnTime - Math.max(0, timeLeft));
                }

                if (currentUser.extraTime <= 0) {
                    isSuddenDeathActive = true;
                }
            }

            function movePlayer(index, direction) {
                if (isTimerRunning) {
                    recordTime();
                } else {
                    stopTimer();
                }

                const currentTurnPlayerName = users[currentUserIndex].name;

                if (direction === 'up' && index > 0) {
                    [users[index], users[index - 1]] = [users[index - 1], users[index]];
                } else if (direction === 'down' && index < users.length - 1) {
                    [users[index], users[index + 1]] = [users[index + 1], users[index]];
                }
                
                // 순서 변경 후, 이전에 턴을 진행하던 플레이어의 새 위치를 찾습니다.
                currentUserIndex = users.findIndex(u => u.name === currentTurnPlayerName);
                
                updateUIForCurrentUser();
                
                nextTurnBtn.classList.add('hidden');
                nextTurnBtn.disabled = true;
                startTurnBtn.classList.remove('hidden');
            }

            function moveToNextUser() {
                stopTimer();
                if (users.filter(u => !u.isEliminated).length === 0) {
                    endGame(null);
                    return;
                }
                hideLapDetails();
                let nextIndex = (currentUserIndex + 1) % users.length;
                while (users[nextIndex].isEliminated) {
                    nextIndex = (nextIndex + 1) % users.length;
                }
                currentUserIndex = nextIndex;
                
                updateUIForCurrentUser();
                
                nextTurnBtn.classList.add('hidden');
                nextTurnBtn.disabled = true;
                startTurnBtn.classList.remove('hidden');
            }

            function updateUIForCurrentUser() {
                const user = users[currentUserIndex];
                currentUserNameEl.textContent = user.name;
                currentUserNameEl.style.color = user.color;
                currentUserExtraTimeEl.textContent = user.extraTime;
                resetTimerVisuals();
                renderLeaderboard();
            }

            function setTimerColor(color) {
                timerDisplayEl.style.color = color;
                timerProgressRing.style.color = color;
            }

            function resetTimerVisuals() {
                timeLeft = turnTime;
                isExtraTimeActive = false;
                updateTimerDisplay(timeLeft);
                timerRingContainer.classList.remove('time-warning', 'time-critical');
                extraTimeIndicator.classList.add('hidden');
                setTimerColor(users[currentUserIndex].color);
                updateProgressRing(timeLeft, turnTime);
            }

            function renderLeaderboard() {
                leaderboardDiv.innerHTML = '';
                users.forEach((user) => { user.totalTimeUsed = user.lapTimes.reduce((sum, lap) => sum + lap, 0); });
                
                leaderboardDiv.innerHTML = users.map((user, index) => {
                    const isCurrentUser = index === currentUserIndex;
                    const leaderStyle = isCurrentUser ? `box-shadow: 0 0 15px ${user.color}80;` : '';
                    return `
                    <div class="leaderboard-item p-3 rounded-lg border border-slate-200 
                        ${user.isEliminated ? 'eliminated' : 'leaderboard-item-clickable'}" data-name="${user.name}" style="${leaderStyle}">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-3">
                                <span class="font-bold text-lg w-6 text-center" style="color: ${user.color};">${index + 1}</span>
                                <span class="font-semibold">${user.name}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="font-bold" style="color: ${user.color};">${formatTime(user.totalTimeUsed)}</span>
                                <div class="flex flex-col">
                                    <button class="move-btn text-xs ${index === 0 ? 'opacity-20' : ''}" data-index="${index}" data-direction="up" ${index === 0 ? 'disabled' : ''}>▲</button>
                                    <button class="move-btn text-xs ${index === users.length - 1 ? 'opacity-20' : ''}" data-index="${index}" data-direction="down" ${index === users.length - 1 ? 'disabled' : ''}>▼</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `}).join('');

                document.querySelectorAll('.leaderboard-item-clickable').forEach(item => {
                    item.addEventListener('click', handleLeaderboardClick);
                });
                document.querySelectorAll('.move-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const index = parseInt(e.currentTarget.dataset.index);
                        const direction = e.currentTarget.dataset.direction;
                        movePlayer(index, direction);
                    });
                });
            }

            function handleLeaderboardClick(event) {
                const selectedName = event.currentTarget.dataset.name;
                document.querySelectorAll('.leaderboard-item').forEach(item => {
                    item.classList.toggle('selected-leaderboard-item', item.dataset.name === selectedName);
                });
                showLapDetails(selectedName);
            }

            function showLapDetails(userName) {
                const user = users.find(u => u.name === userName);
                if (!user) return;

                lapDetailsTitle.textContent = `${user.name} - 상세 기록`;
                lapDetailsTitle.style.color = user.color;
                if (user.lapTimes.length > 0) {
                    lapDetailsList.innerHTML = user.lapTimes.map((lap, i) => 
                        `<div class="flex justify-between p-2 bg-slate-50 rounded-md">
                            <span>랩 ${i + 1}</span>
                            <span class="font-mono">${formatTime(lap)}</span>
                         </div>`
                    ).join('');
                } else {
                    lapDetailsList.innerHTML = `<p class="text-slate-500">아직 기록이 없습니다.</p>`;
                }
                lapDetailsView.classList.remove('hidden');
            }

            function hideLapDetails() {
                lapDetailsView.classList.add('hidden');
                document.querySelectorAll('.leaderboard-item').forEach(item => {
                    item.classList.remove('selected-leaderboard-item');
                });
            }

            function resetAll() {
                stopTimer(true);
                settingsView.classList.remove('hidden');
                timerView.classList.add('hidden');
                gameOverModal.classList.add('hidden');
                summaryModal.classList.add('hidden');
                scoreInputModal.classList.add('hidden');
                hideLapDetails();
                users = [];
                renderUserList();
                updateStartButtonState();
            }

            function toggleMute() {
                isMuted = !isMuted;
                volumeIcon.classList.toggle('hidden', isMuted);
                muteIcon.classList.toggle('hidden', !isMuted);
            }
            
            function showNotification(message, bgColor, textColor) {
                notificationEl.textContent = message;
                notificationEl.className = `absolute top-1/3 left-1/2 -translate-x-1/2 -translate-y-1/2 font-bold px-6 py-3 rounded-full shadow-lg opacity-0 transform scale-50 z-20 ${bgColor} ${textColor}`;
                notificationEl.classList.remove('opacity-0', 'scale-50');
                notificationEl.classList.add('opacity-100', 'scale-100');
                setTimeout(() => {
                    notificationEl.classList.remove('opacity-100', 'scale-100');
                    notificationEl.classList.add('opacity-0', 'scale-50');
                }, 2000);
            }

            function stopTimer(isPermanent = false) {
                clearInterval(timerInterval);
                isTimerRunning = false;
                timerRingContainer.classList.remove('time-warning', 'time-critical');
                if (isPermanent) {
                    clearInterval(totalGameTimeInterval);
                }
            }
            
            function updateTimerDisplay(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                timerDisplayEl.textContent = `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
            }

            function updateProgressRing(currentTime, totalTime) {
                const progress = Math.max(0, currentTime) / totalTime;
                const offset = ringCircumference * (1 - progress);
                timerProgressRing.style.strokeDashoffset = offset;
            }

            function formatTime(seconds) {
                const totalSeconds = Math.round(seconds);
                const mins = Math.floor(totalSeconds / 60);
                const secs = totalSeconds % 60;
                return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
            }

            updateStartButtonState();
        });
    </script>
</body>
</html>
